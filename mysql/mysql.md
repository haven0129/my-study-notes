# mysql

## 事务特点

### A（原子性）:事务里的一系列操作，要么都执行，要么都不执行

### C（一致性）：从一个一致性状态到另一个一致性状态（比如转账，不管转多少次，两个账户总金额是一样的）

由原子性，隔离性，持久性最终来保证事务的一致性

### I（隔离性）：事务与事务之间互不干涉，跟串行执行是一样的结果

### D（持久性）：每次事务操作都是持久化的，即使系统挂了重启后还是事务执行后的结果（存到磁盘）

## 数据库系统技术

### 并发控制技术

- 保证事务的隔离性
- 保证事务的一致性

### 日志恢复技术

- 保证事务的原子性
- 保证事务的持久性
- 保证事务的一致性

## 事务实现原理

### redo log实现持久性

### undo log实现原子性

### 读写锁 + mvcc实现隔离性

### 原子性 + 持久性 + 隔离性 实现一致性

## redo log持久化实现原理（InnoDB）

mysql数据持久性原理，使用redo log，在数据持久化之前，只需要将redo log持久化即可，不需要将数据持久化。当系统崩溃时，虽然没有数据持久化，但是redo log已经持久化。系统可以根据redo log的内容，将数据恢复到最新状态。

### 实现步骤

- 1、先写日志（redo）到Log Buffer
- 2、再写入到OS Buffer
- 3、调用fync()方法刷到磁盘

### 写入磁盘方式

- 参数0：每秒写入到OS Buffer并调用fync()方法刷到磁盘

  性能最高，数据一致性最差，如果mysql奔溃可能丢失一秒的数据

- 参数1：每次提交写入到OS Buffer并调用fync()方法刷到磁盘

  性能最差，一致性最高

- 参数2：每次提交时写入到OS Buffer，每秒调用fync()方法刷到磁盘

  性能好，安全性也高，只要os不宕机就能保证数据一致性

## 索引

### 相关基础知识

- 局部性原理

	- 空间局部性

		- 程序和数据的访问都有聚集成群的倾向，在一个时间段内，仅使用其中一小部分

	- 时间局部性

		- 最近访问过的程序代码和数据，很快又被访问的可能性很大

- 磁盘预读

	- 页是存储器的逻辑块，操作系统往往将主存和磁盘存储区分为连续的大小相同的块，每个存储块称为一页（很多操作系统中，页大小通常为4k），主存和磁盘以页为单位交换数据（mysql一次读16k）

- 虚拟内存

	- 用户空间（User Space）

		- 应用程序

	- 内核空间（Kernel Space）

		- 操作系统
		- 驱动程序

### 索引基础知识

- 什么是索引？

	- 索引是帮助mysql高效获取数据的数据结构

- 索引存储位置

	- 索引存储在文件系统中

- 索引文件存储形式与存储引擎相关
- 索引文件的结构

	- hash

		- 如果用hash存储，需要将所有数据放内存，比较耗费内存空间
		- 如果是等值查询，使用hash存储查询比较快，但是企业或实际工作中范围查询用到的比较多，所以hash存储不太合适

	- 二叉树

	  二叉树：每个节点最多只能有两个子节点的叫二叉树
	  AVL树:	在AVL树中任何节点的两个子树的高度最大差别为1，所以它也被称为	高度平衡树(查找性能好，但是增删改耗费太多性能)
	  红黑树：	是一种自平衡二叉查找树

		- BST树

		  二叉搜索树（Binary Search Tree，简称BST树），又称二叉排序树，树的节点包含了键值key，数据值data，左子节点指针，右子节点指针。
		  特点：
		  左右子树也分别是二叉搜索树
		  左子树的所有节点的key值都小于它根节点的key值
		  右子树所有节点的key值都大于它根节点的key值

		- AVL树

		  AVL树也称为平衡二叉搜索树，通过一定机制能保证二叉搜索树的平衡，平衡二叉搜索树的查询效率更高。
		  特点：
		  AVL树是一颗二叉搜索树
		  AVL树的左右节点是一颗AVL树
		  AVL树拥有二叉搜索树的所有基本特点
		  每个节点的左右子节点的高度之差的绝对值最多为1

		- 红黑树

		  红黑树（red-black）是一种平衡二叉查找树，于AVL树类似，它在插入和删除操作时，通过旋转操作保持二叉查找树的平衡。对于AVL来说，红黑树牺牲了部分平衡性能以换取插入/删除操作时少量的旋转操作，整体性能优于AVL.
		  特点：
		  节点是红色或黑色
		  根节点是黑色
		  每个叶节点（NIL节点）是黑色的
		  每个红色节点的两个子节点都是黑色（从每个叶子到根的所有路径上不能有两个连续的红色节点）
		  从任意一个节点到其叶子节点的所有路径都包含相同数目的黑色节点
		  最长路径不超过最短路径的二倍

	- B树

	  B树属于多叉树又名平衡多路查找树
	  特点：
	  所有键值分布在整颗树中
	  搜索有可能在非叶子节点结束，在关键字全集内做一次查找，性能逼近二分查找
	  每个子节点最多拥有m个子树
	  根节点至少有2个子树
	  分支节点至少拥有m/2颗子树（除根节点和叶子节点外都是分支节点）
	  所有叶子节点都在同一层，每个节点最多可以有m-1个key，并且以升序排列

		- 缺点

			- 每个节点都包含key，同时还包含data，而每个页存储空间是有限的，如果data比较大的话，会导致每个节点存储的key数量变小
			- 当存储的数据量很大的时候会导致深度较大，增大查询时磁盘io的次数，进而影响查询性能

	- B+树(mysql选用)

	  B+树是在B树的基础之上的一种优化，变化如下：
	  B+树每个节点可以包含更多的节点，这个做的原因有两个，第一个原因是为了降低树的高度，第二个原因是将数据范围变为多个区间，区间越多，数据检索越快
	  非叶子节点存储Key,叶子节点存储key和数据
	  叶子节点两两指针相互连接（符合磁盘的预读特性），顺序查询性能更高

		- Myisam

			- 非聚簇型索引

			  将数据与索引分开存储，索引结构的叶子节点指向了数据对应的位置

		- InnoDB

			- 聚簇型索引

			  将数据存储与索引放到了一块，索引结构的叶子节点保存了行数据

- mysql索引分类

	- 主键索引

		- 主键是一种唯一性索引，但它必须指定为PARAM KEY，每个表只能有一个主键

	- 唯一索引

		- 索引列的索引值只能出现一次，即必须唯一，值可以为空

	- 普通索引

		- 基本的普通索引，值可以为空，没有唯一性的约束

	- 全文索引

		- 全文索引的类型为FULLTXT，全文索引可以在vachar,char,text类型的列上创建

	- 组合索引

		- 多列值用来组合成一个索引，专门用户组合查询

- 索引一些概念

	- 回表

		- 如果创建索引的列是非主键索引的其他字段，那么叶子节点里面的数据存储的是其主键的值（非整行数据），然后在根据主键，通过主键索引找到对应的那一行的数据，叫做回表
		- 如果没有主键，那么找唯一键，如果没有唯一键，那么会生成一个6位的row_id来作为主键

	- 索引覆盖

		- 如果根据普通索引，查找主键的值，那么不需要再根据主键索引找对应的行数据了，这就叫索引覆盖

		  select id from t1 where t1.name = 'name1'

	- 最左匹配原则

		- 组合索引情况下，最左优先，以最左边的为起点任何连续的索引都能匹配上。同时遇到范围查询(>、<、between、like)就会停止匹配

		  建立一个(age ,sex)为顺序的组合索引：
		  
		  select * from user where age = 1 and sex = 1;能匹配
		  select * from user where sex = 1 and age = 1;能匹配，优化器自动优化可以改变顺序
		  select * from user where age = 1 ;能匹配
		  select * from user where sex = 1 ;不能匹配
		  select * from user where sex > 1 and age = 1;sex能用到索引，age用不到

	- 索引下推（mysql 5.6+版本）

		- 组合索引情况下，如果在存储引擎层根据（a,b）a筛选，然后在存储引擎层根据b筛选，然后再获得数据到mysql server层，就使用到了索引下推（mysql默认启用索引下推）。如果在存储引擎层根据a筛选数据，拉取到mysql server层，然后在server层根据b索引筛选，这种情况从存储引擎到server的时候io量变大，会导致速度变慢。

## mysql的隔离级别

### 读未提交（READ UNCOMMITTED）

- 脏读
- 不可重复读
- 幻读

### 读已提交(READ COMMITTED)

- 不可重复读
- 幻读

### 可重复读(REPEATABLE READ)默认

- 幻读

### 串行化(SERIALIZABLE)

## mysql在innoBD中锁

### 分类

- 共享锁：数据只读，读取锁定
- 排他锁：不能读取，写入锁定

### 粒度

- 行（默认）

	- 如果加了索引，查询的时候是行锁

- 表

	- 如果没有加索引，查询的时候是表级锁

## mysql系统架构

### 客户端

- 可视化工具
- jdbc
- cli
- 等等。。。

### mysql服务端

- 连接器：控制用户的连接
- 分析器：词法分析，语法分析
- 优化器：优化sql语句，规定执行流程
- 执行器：sql语句的实际执行组件

### 存储引擎

- InnoDB磁盘(mysql默认)
- MyISAM磁盘
- memory内存

## InnoDB和MyiSAM的区别

### MyiSAM

- 非聚簇索引
- 不支持事务
- 有表锁
- 无行锁
- 不支持外键
- 支持全文索引
- 适合大量select

### InnoDB

- 聚簇索引
- 支持事务
- 有表锁
- 有行锁
- 支持外键
- 支持全文索引（5.6以后）
- 适合大量insert,select,update

## mysql日志

### bin log

- mysql服务端日志

### undo log（回滚日志）

- 当insert一条语句的时候，undo log中会记录一条对应的delete语句。
- 当delete一条语句的时候，undo log中会记录一条对应的insert语句。
- 当update一条语句的时候，undo log中会记录一条相反的update语句。

### redo log（前滚日志）

- 在事务提交前，先持久化到redo log，然后再持久化到磁盘

*XMind - Trial Version*