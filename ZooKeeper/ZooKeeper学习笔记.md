# ZooKeeper学习笔记

## 一致性级别

### 强一致性：用户体验好，性能较差

### 弱一致性

- 会话一致性：同一个客户端会话中读到一致的值
- 用户一致性：同一个用户中可以读到一致的值

### 最终一致性：一定时间内达到数据一致，弱一致性中的一个非常重要的模型，被业界大型分布式系统推崇

## 集中式到分布式

### 集中式

- 优点

	- 部署结构简单

- 缺点

	- 对服务器性能要求高

### 分布式

- 特点

	- 分布性：空间上随意分布
	- 对等性：计算机没有主从之分
	- 并发性：并发的操作一些共享资源

- 优点

	- 可靠性（容错）
	- 可扩展性
	- 资源共享
	- 更高的性能

- 缺点

	- 运维比较困难：部署包括问题排查
	- 安全性：存在数据安全性和共享的风险

## 事务

### ACID

- A（原子性）:事务里的一系列操作，要么都执行，要么都不执行
- C（一致性）：从一个一致性状态到另一个一致性状态（比如转账，不管转多少次，两个账户总金额是一样的）

  由原子性，隔离性，持久性最终来保证事务的一致性

- I（隔离性）：事务与事务之间互不干涉，跟串行执行是一样的结果

	- 隔离级别

		- 未授权读取（READ UNCOMMITTED）

			- 脏读
			- 不可重复读
			- 幻读

		- 授权读取(READ COMMITTED)

			- 不可重复读
			- 幻读

		- 可重复读取(REPEATABLE READ)

			- 幻读

		- 串行化(SERIALIZABLE)

- D（持久性）：每次事务操作都是持久化的，即使系统挂了重启后还是事务执行后的结果（存到磁盘）

### CAP定理

- 一致性：数据在多个副本直接是否能保持一致
- 可用性：服务处于可用状态
- 分区容错性

### BASE理论

- 基本可用（系统故障时允许损失部分可用性）

	- 响应时间上的损失
	- 功能上的损失

- 弱状态：允许数据存在中间状态
- 最终一致性：允许经过一定时间后，数据最终达到一致状态

## 一致性协议

### 2PC

- 执行流程

	- 一、提交事务请求

		- 1、事务询问
		- 2、执行事务
		- 3、各参与者向协调者反馈事务查询的响应

	- 二、执行事务提交

		- 执行事务提交

			- 1、发送提交请求
			- 2、事务提交
			- 3、反馈事务提交结果
			- 4、完成事务

		- 中断事务

			- 1、发送回滚请求
			- 2、事务回滚
			- 3、反馈事务回滚结果
			- 4、中断事务

- 优点

	- 原理简单
	- 实现方便

- 缺点

	- 同步阻塞：等待响应过程中，无法进行其他操作
	- 单点问题：协调者只有一个，一旦出现问题，就会崩溃
	- 脑裂
	- 太过保守

### 3PC

- 执行流程

	- 一、CanCommit

		- 1、事务询问
		- 2、各参与者向协调者反馈事务询问的响应

	- 二、PreCommit

		- 执行事务预提交

			- 1、发送预提交请求
			- 2、事务预提交
			- 3、各参与者向协调者反馈事务执行的响应

		- 中断事务

			- 1、发送中断请求
			- 2、中断事务

	- 三、DoCommit

		- 执行提交

			- 1、发送提交请求
			- 2、事务提交
			- 3、反馈事务提交结果
			- 4、完成事务

		- 中断事务

			- 1、发送中断请求
			- 2、事务回滚
			- 3、反馈事务回滚结果
			- 4、中断事务

- 优点

	- 降低参与者的阻塞范围
	- 出现单点故障后能够继续达成一致

- 缺点

	- 参与者接收到PreCommit之后，如果些调整和参与者出现通信问题，参与者依然会提交事务，会导致数据不一致

## Paxos算法

*XMind - Trial Version*